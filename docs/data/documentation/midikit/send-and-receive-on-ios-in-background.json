{"sections":[],"hierarchy":{"paths":[["doc:\/\/MIDIKit\/documentation\/MIDIKit","doc:\/\/MIDIKit\/documentation\/MIDIKit\/MIDIKitIO"]]},"metadata":{"modules":[{"name":"MIDIKit"}],"title":"Send and Receive on iOS While Your App is Backgrounded","roleHeading":"Article","role":"article"},"kind":"article","identifier":{"interfaceLanguage":"swift","url":"doc:\/\/MIDIKit\/documentation\/MIDIKit\/Send-and-Receive-on-iOS-in-Background"},"abstract":[{"text":"Keeping your iOS app alive while it is in the background to allow MIDI messages to be sent and received.","type":"text"}],"primaryContentSections":[{"content":[{"text":"Context","anchor":"Context","type":"heading","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"By default, iOS places apps into a suspended state when they are backgrounded (user either switches to a different app, goes back to the home screen, or powers the screen off)."}]},{"inlineContent":[{"type":"text","text":"In this state, sending and receiving MIDI events is also suspended."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"In order to have a good chance of passing App Store review, an entitlement needs to be added for a reason and not purely as a workaround.","type":"text"}]},{"type":"heading","level":2,"text":"Producing Audio While in Background","anchor":"Producing-Audio-While-in-Background"},{"type":"paragraph","inlineContent":[{"type":"text","text":"If the application generates audio in response to receiving MIDI, you may add a background mode to allow audio playback which will keep the app (and the MIDI runloop) alive."}]},{"type":"paragraph","inlineContent":[{"text":"However be aware that an audio stream must be playing to keep the app alive. The Apple docs state:","type":"text"}]},{"type":"aside","content":[{"inlineContent":[{"type":"text","text":"As long as [the app] is playing audio or video content or recording audio content, the app continues to run in the background. However, if recording or playback stops, the system suspends the app."}],"type":"paragraph"}],"style":"note","name":"Note"},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Add the "},{"type":"emphasis","inlineContent":[{"text":"Background Modes -> Audio, Airplay, and Picture in Picture","type":"text"}]},{"type":"text","text":" app entitlement."}],"type":"paragraph"}]}]},{"type":"paragraph","inlineContent":[{"identifier":"background-modes-audio.png","type":"image"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Use AVFoundation to set up the appâ€™s audio session."}]},{"type":"codeListing","code":["try AVAudioSession.sharedInstance()","    .setCategory(.playback, mode: .default, options: .mixWithOthers)"],"syntax":"swift"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Set the session as active either once at app startup, or dynamically make it active when the app is backgrounded (and inactive when the app is foregrounded)."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"An example implementation where a silent audio stream is played while the app is backgrounded, allowing for additional audio to play at any time as well:"}]},{"code":["import AVFoundation","","public final class BackgroundAudioManager {","    private var audioPlayer: AVPlayer","","    public init() {","        let playerItem = AVPlayerItem(url: URL(fileURLWithPath: \"\")) \/\/ empty audio","        audioPlayer = AVPlayer(playerItem: playerItem)","","        do {","            try AVAudioSession.sharedInstance()","                .setCategory(.playback, mode: .default, options: .mixWithOthers)","        } catch {","            print(\"Error setting up background audio session: \\(error)\")","        }","    }","","    private func setActive(_ state: Bool) {","        do {","            try AVAudioSession.sharedInstance().setActive(state)","        } catch {","            print(\"Error setting background audio state: \\(error)\")","        }","    }","","    public func start() {","        setActive(true)","        audioPlayer.play()","    }","","    public func stop() {","        audioPlayer.pause()","        setActive(false)","    }","}"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"Start background audio when your app transitions to the background and stop it when in the foreground.","type":"text"}]},{"type":"heading","anchor":"SwiftUI","text":"SwiftUI","level":4},{"type":"codeListing","syntax":"swift","code":["@main","struct MyApp: App {","    @Environment(\\.scenePhase) private var scenePhase","    private let backgroundAudioManager = BackgroundAudioManager()","    ","    var body: some Scene {","        WindowGroup {","            ContentView() \/\/ your main view","                .onChange(of: scenePhase) { phase in","                    switch phase {","                    case .active: \/\/ App is in the foreground","                        backgroundAudioManager.stop()","                    case .inactive: \/\/ App is transitioning between fore and back","                        break","                    case .background: \/\/ App is in the background","                        backgroundAudioManager.start()","                    @unknown default: \/\/ Handle any future unknown cases","                        break","                    }","                }","        }","    }","}"]},{"type":"heading","text":"UIKit Using Scenes","level":4,"anchor":"UIKit-Using-Scenes"},{"type":"codeListing","syntax":"swift","code":["class SceneDelegate: UIResponder, UIWindowSceneDelegate {","    private let backgroundAudioManager = BackgroundAudioManager()","","    func sceneDidBecomeActive(_ scene: UIScene) {","        backgroundAudioManager.stop()","    }","","    func sceneWillResignActive(_ scene: UIScene) {","        backgroundAudioManager.start()","    }","}"]},{"text":"UIKit Without Scenes","anchor":"UIKit-Without-Scenes","level":4,"type":"heading"},{"type":"codeListing","syntax":"swift","code":["@main","class AppDelegate: UIResponder, UIApplicationDelegate {","    private let backgroundAudioManager = BackgroundAudioManager()","    ","    func applicationDidBecomeActive(_ application: UIApplication) {","        backgroundAudioManager.stop()","    }","    ","    func applicationWillResignActive(_ application: UIApplication) {","        backgroundAudioManager.start()","    }","}"]}]}],"type":"orderedList","start":2}],"kind":"content"}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/midikit\/send-and-receive-on-ios-in-background"]}],"schemaVersion":{"major":0,"minor":3,"patch":0},"references":{"doc://MIDIKit/documentation/MIDIKit":{"kind":"symbol","type":"topic","identifier":"doc:\/\/MIDIKit\/documentation\/MIDIKit","url":"\/documentation\/midikit","abstract":[{"type":"text","text":"MIDIKit umbrella import that includes all MIDIKit modules."}],"title":"MIDIKit","role":"collection"},"background-modes-audio.png":{"alt":"Background Modes","variants":[{"url":"\/images\/background-modes-audio.png","traits":["1x","light"]}],"type":"image","identifier":"background-modes-audio.png"},"doc://MIDIKit/documentation/MIDIKit/MIDIKitIO":{"title":"MIDIKitIO","kind":"article","type":"topic","url":"\/documentation\/midikit\/midikitio","role":"collectionGroup","identifier":"doc:\/\/MIDIKit\/documentation\/MIDIKit\/MIDIKitIO","abstract":[{"type":"text","text":"Core MIDI I\/O wrapper layer offering "},{"type":"reference","identifier":"doc:\/\/MIDIKit\/documentation\/MIDIKit\/MIDIManager","isActive":true},{"text":" class to create virtual ports and connect to existing ports in the system in order to send and receive MIDI events.","type":"text"}]},"doc://MIDIKit/documentation/MIDIKit/MIDIManager":{"title":"MIDIManager","kind":"symbol","type":"topic","url":"\/documentation\/midikit\/midimanager","role":"symbol","navigatorTitle":[{"text":"MIDIManager","kind":"identifier"}],"identifier":"doc:\/\/MIDIKit\/documentation\/MIDIKit\/MIDIManager","fragments":[{"kind":"keyword","text":"class"},{"text":" ","kind":"text"},{"text":"MIDIManager","kind":"identifier"}],"abstract":[{"type":"text","text":"Central MIDI Port and Connection Manager and MIDI system data provider."}]}}}